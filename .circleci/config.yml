version: 2.1
orbs:
  aws-cli: circleci/aws-cli@3.1.4
  aws-ecr: circleci/aws-ecr@7.3.0
  aws-ecs: circleci/aws-ecs@3.2.0
  shellcheck: circleci/shellcheck@2.2
  jq: circleci/jq@2.2.0

executors:
  node-executor:
    docker:
      - image: cimg/node:18.12.1

jobs:
  aws-setup:
    executor: aws-cli/default
    working_directory: ~/node/backend_app
    steps:
      - aws-cli/setup:
          profile-name: default
      - persist_to_workspace:
          root: ~/node/backend_app
          paths:
            - .
  build-migration-image:
    executor:
      name: aws-ecr/default
      use-docker-layer-caching: true
    working_directory: ~/node/backend_app
    environment:
      ACCOUNT_URL: 545108995501.dkr.ecr.ap-southeast-3.amazonaws.com
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Get ENV
          command: |
            echo 'export NODE_ENV=${NODE_ENV}' >> "$BASH_ENV"
            export HOST=${HOST}
            export PORT=${PORT}
            export MONGODB_URI=${MONGODB_URI}
            export REDIS_HOST=${REDIS_HOST}
            export REDIS_PORT=${REDIS_PORT}
            export TOKEN_ISSUER=${TOKEN_ISSUER}
            export SECRET=${SECRET}
            export SYMMETRIC_ALGO=${SYMMETRIC_ALGO}
            export TZ=${TZ}
            export LOGS_DIR=${LOGS_DIR}
            export ERROR_LOG_FILENAME=${ERROR_LOG_FILENAME}
            echo $NODE_ENV
      - aws-ecr/build-and-push-image:
          account-url: ACCOUNT_URL
          dockerfile: Dockerfile
          profile-name: default
          region: AWS_DEFAULT_REGION
          repo: 545108995501.dkr.ecr.ap-southeast-3.amazonaws.com/contact-repository
          tag: "migration-latest,migration-${CIRCLE_BUILD_NUM}"
  run-migrations:
    executor: aws-cli/default
    working_directory: ~/node/backend_app
    steps:
      - aws-cli/setup
      - jq/install
      - attach_workspace:
          at: .
      - aws-cli/setup:
          profile-name: default
      - run:
          name: Get cluster info
          command: |
            SERVICES_OBJ=$(aws ecs describe-services --cluster "${ECS_CLUSTER_NAME}" --services "${ECS_SERVICE_NAME}")
            VPC_CONF_OBJ=$(echo $SERVICES_OBJ | jq '.services[].networkConfiguration.awsvpcConfiguration')
            SUBNET_ONE=$(echo "$VPC_CONF_OBJ" | jq '.subnets[0]')
            SUBNET_TWO=$(echo "$VPC_CONF_OBJ" | jq '.subnets[1]')
            SECURITY_GROUP_IDS=$(echo "$VPC_CONF_OBJ" | jq '.securityGroups[0]')
            CLUSTER_NAME=$(echo "$SERVICES_OBJ" | jq '.services[].clusterArn')
            export SUBNET_ONE=$SUBNET_ONE
            export SUBNET_TWO=$SUBNET_TWO
            export SECURITY_GROUP_IDS=$SECURITY_GROUP_IDS
            export CLUSTER_NAME=$CLUSTER_NAME
      - run:
          name: Associate cluster
          command: |
            aws ecs put-cluster-capacity-providers \
              --cluster "${ECS_CLUSTER_NAME}" \
              --capacity-providers FARGATE FARGATE_SPOT  \
              --default-capacity-provider-strategy capacityProvider=FARGATE,weight=1 capacityProvider=FARGATE_SPOT,weight=1\
              --region ${AWS_DEFAULT_REGION}
      - aws-ecs/run-task:
          cluster: $CLUSTER_NAME
          capacity-provider-strategy: capacityProvider=FARGATE,weight=1 capacityProvider=FARGATE_SPOT,weight=1
          launch-type: ""
          task-definition: webapp-fargate-task
          subnet-ids: "$SUBNET_ONE, $SUBNET_TWO"
          security-group-ids: $SECURITY_GROUP_IDS
          assign-public-ip: ENABLED
          count: 4

workflows:
  version: 2
  build-deploy-main:
    jobs:
      - aws-setup:
          filters:
            branches:
              only:
                - main
          context: main
      - run-migrations:
          filters:
            branches:
              only:
                - main
          context: main
          requires:
            - aws-setup
            - build-migration-image
      - build-migration-image:
          filters:
            branches:
              only:
                - main
          context: main
          requires:
            - aws-setup
